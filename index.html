<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Casino Hold‚Äôem ‚Äî Mini App</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <style>
    :root{
      --bg: var(--tg-theme-bg-color, #0b0f14);
      --text: var(--tg-theme-text-color, #e8eef7);
      --hint: var(--tg-theme-hint-color, #9fb0c3);
      --btn: var(--tg-theme-button-color, #2ea6ff);
      --btnText: var(--tg-theme-button-text-color, #ffffff);
      --card: rgba(255,255,255,.06);
      --stroke: rgba(255,255,255,.10);
      --good: rgba(46,166,255,.18);
      --bad: rgba(255,80,80,.18);
    }
    body{ margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background: var(--bg); color: var(--text); }
    .wrap{ max-width: 900px; margin: 0 auto; padding: 14px 14px 24px; }
    h1{ font-size: 18px; margin: 6px 0 10px; font-weight: 650; }
    .sub{ color: var(--hint); font-size: 13px; line-height: 1.35; margin-bottom: 12px; }
    .panel{ background: var(--card); border: 1px solid var(--stroke); border-radius: 14px; padding: 12px; margin: 12px 0; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; justify-content:space-between; }
    .pill{ background: rgba(255,255,255,.07); border: 1px solid var(--stroke); border-radius: 999px; padding: 8px 10px; font-size: 13px; color: var(--hint); display:flex; gap:8px; align-items:center; width: fit-content; }
    .cardsLine{ font-size: 16px; letter-spacing: .3px; word-spacing: 6px; margin-top: 8px; padding: 10px 12px; border-radius: 12px; background: rgba(0,0,0,.18); border: 1px solid var(--stroke); }
    .label{ font-size: 12px; color: var(--hint); margin-top: 10px; margin-bottom: 6px; }
    .grid{ display:grid; grid-template-columns: repeat(7, minmax(0, 1fr)); gap: 8px; }
    .grid2{ display:grid; grid-template-columns: repeat(5, minmax(0, 1fr)); gap: 8px; }
    .gridActions{ display:grid; grid-template-columns: repeat(2, minmax(0, 1fr)); gap: 8px; }
    button{ border: 1px solid var(--stroke); background: rgba(255,255,255,.06); color: var(--text); border-radius: 12px; padding: 11px 10px; font-size: 14px; font-weight: 650; cursor: pointer; user-select:none; }
    button:active{ transform: translateY(1px); }
    .rank.selected{ background: var(--good); border-color: rgba(46,166,255,.35); }
    .suitBtn{ font-size: 16px; }
    .danger{ background: var(--bad); border-color: rgba(255,80,80,.35); }
    .primary{ background: var(--btn); border-color: transparent; color: var(--btnText); font-weight: 750; }
    .small{ font-size: 12px; color: var(--hint); margin-top: 10px; line-height: 1.35; }
    .toast{ display:none; margin-top:10px; padding:10px 12px; border-radius: 12px; background: rgba(255,255,255,.08); border: 1px solid var(--stroke); color: var(--text); font-size: 13px; }
    .mono{ font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size: 12px; color: var(--hint); word-break: break-all; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Casino Hold‚Äôem</h1>
    <div class="sub">
      –í—Å—ë –¥–µ–ª–∞–µ—Ç–µ <b>—Ç–æ–ª—å–∫–æ –∑–¥–µ—Å—å</b> ‚Äî –≤–Ω—É—Ç—Ä–∏ Mini App.<br/>
      –ü–æ—Ä—è–¥–æ–∫: <b>2 –∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞</b>, –∑–∞—Ç–µ–º <b>3 –∫–∞—Ä—Ç—ã —Ñ–ª–æ–ø–∞</b>.
    </div>

    <div class="panel">
      <div class="gridActions">
        <button class="primary" id="btnBuy">‚≠ê –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É</button>
        <button class="primary" id="btnStatus">üìå –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏</button>
      </div>

      <div class="row" style="margin-top:10px;">
        <div class="pill">–®–∞–≥: <b id="stageText">–∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞ (0/2)</b></div>
        <div class="pill">–ü—Ä–∏–º–µ—Ä: <b>A‚ô• K‚ô£ Q‚ô¶ J‚ô† 2‚ô•</b></div>
      </div>

      <div class="label">–í—ã–±—Ä–∞–Ω–Ω—ã–µ –∫–∞—Ä—Ç—ã</div>
      <div class="cardsLine" id="cardsLine">‚Äî</div>

      <div class="label">–†–µ–∑—É–ª—å—Ç–∞—Ç</div>
      <div class="cardsLine" id="resultLine">‚Äî</div>

      <div class="label">–ù–æ–º–∏–Ω–∞–ª—ã (A‚Ä¶2)</div>
      <div class="grid" id="ranks"></div>

      <div class="label">–ú–∞—Å—Ç–∏ (‚ô• ‚ô£ ‚ô¶ ‚ô†)</div>
      <div class="grid2">
        <button class="danger" id="btnDel">–£–¥–∞–ª–∏—Ç—å</button>
        <button class="suitBtn" data-suit="‚ô•">‚ô•</button>
        <button class="suitBtn" data-suit="‚ô£">‚ô£</button>
        <button class="suitBtn" data-suit="‚ô¶">‚ô¶</button>
        <button class="suitBtn" data-suit="‚ô†">‚ô†</button>
        <button class="danger" id="btnReset" style="grid-column: 1 / span 5;">–°–±—Ä–æ—Å</button>
      </div>

      <div class="toast" id="toast"></div>

      <div class="small">
        ‚Äú–û–¥–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ‚Äù: –µ—Å–ª–∏ –æ—Ç–∫—Ä–æ–µ—Ç–µ Mini App –Ω–∞ –¥—Ä—É–≥–æ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–µ ‚Äî –¥–æ—Å—Ç—É–ø –±—É–¥–µ—Ç –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω.<br/>
        –ß—Ç–æ–±—ã –ø–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø –Ω–∞ —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ ‚Äî –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ.
      </div>
      <button class="primary" id="btnTakeover" style="width:100%; margin-top:10px;">–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø –Ω–∞ —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ</button>

      <div class="label">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏</div>
      <div class="mono" id="techLine">API: ‚Äî</div>
    </div>
  </div>

<script>
  const tg = window.Telegram?.WebApp;
  if (tg) {
    tg.ready();
    tg.expand();
    tg.enableClosingConfirmation();
    if (tg.disableVerticalSwipes) tg.disableVerticalSwipes();
  }

  function toast(msg){
    const el = document.getElementById('toast');
    el.textContent = msg;
    el.style.display = 'block';
    clearTimeout(window.__t);
    window.__t = setTimeout(()=> el.style.display='none', 2600);
  }

  // device_id: —É–Ω–∏–∫–∞–ª–µ–Ω –Ω–∞ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ/–±—Ä–∞—É–∑–µ—Ä
  const LS_KEY = "casino_holdem_device_id";
  let deviceId = localStorage.getItem(LS_KEY);
  if (!deviceId) {
    deviceId = (crypto.randomUUID ? crypto.randomUUID() : (Date.now()+"_"+Math.random()));
    localStorage.setItem(LS_KEY, deviceId);
  }

  // API base –∏–∑ query ?api=...
  const apiBase = (() => {
    try {
      const p = new URLSearchParams(location.search);
      const v = p.get("api");
      return (v || "").replace(/\/+$/,"");
    } catch { return ""; }
  })();

  document.getElementById('techLine').textContent = "API: " + (apiBase || "‚Äî (–Ω—É–∂–Ω–æ ?api=https%3A%2F%2F...)");

  function setCardsText(txt){
    document.getElementById('cardsLine').textContent = txt || "‚Äî";
  }
  function setResultText(txt){
    document.getElementById('resultLine').textContent = txt || "‚Äî";
  }

  async function apiPost(path, body){
    if (!apiBase) throw new Error("–ù–µ –∑–∞–¥–∞–Ω API. –î–æ–±–∞–≤—å—Ç–µ ?api=https%3A%2F%2F... –∫ WEBAPP_URL");
    if (!tg?.initData) throw new Error("–û—Ç–∫—Ä–æ–π—Ç–µ Mini App —á–µ—Ä–µ–∑ Telegram.");

    const res = await fetch(apiBase + path, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        initData: tg.initData,
        device_id: deviceId,
        ...body
      })
    });

    const data = await res.json().catch(()=> ({}));
    if (!res.ok) {
      const msg = data?.error || data?.detail || ("HTTP " + res.status);
      throw new Error(msg);
    }
    return data;
  }

  async function bootstrap(){
    try {
      const s = await apiPost("/api/bootstrap", {});
      if (!s.device_ok) {
        toast("‚õî –î–æ—Å—Ç—É–ø –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø¬ª.");
        return;
      }
      if (s.sub_active) toast("‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞");
      else toast(`‚ùå –ü–æ–¥–ø–∏—Å–∫–∞ –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞: ${s.price} ‚≠êÔ∏è / 30 –¥–Ω–µ–π`);
    } catch (e) {
      toast(String(e.message || e));
    }
  }

  document.getElementById('btnStatus').onclick = async () => {
    try {
      const s = await apiPost("/api/status", {});
      if (!s.device_ok) {
        toast("‚õî –î–æ—Å—Ç—É–ø –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø¬ª.");
        return;
      }
      if (s.sub_active) toast(`‚úÖ –ê–∫—Ç–∏–≤–Ω–∞, –æ—Å—Ç–∞–ª–æ—Å—å ~${s.left_hours} —á`);
      else toast(`‚ùå –ù–µ –∞–∫—Ç–∏–≤–Ω–∞: ${s.price} ‚≠êÔ∏è / 30 –¥–Ω–µ–π`);
    } catch (e) { toast(String(e.message || e)); }
  };

  document.getElementById('btnTakeover').onclick = async () => {
    try {
      const r = await apiPost("/api/takeover", {});
      toast(r.moved ? "‚úÖ –î–æ—Å—Ç—É–ø –ø–µ—Ä–µ–Ω–µ—Å—ë–Ω –Ω–∞ —ç—Ç–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ" : "‚úÖ OK");
    } catch (e) { toast(String(e.message || e)); }
  };

  document.getElementById('btnBuy').onclick = async () => {
    try {
      const r = await apiPost("/api/create_invoice", {});
      if (!tg?.openInvoice) throw new Error("openInvoice –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è —ç—Ç–∏–º –∫–ª–∏–µ–Ω—Ç–æ–º Telegram");
      tg.openInvoice(r.invoice_link, async (status) => {
        if (status === "paid") {
          toast("‚úÖ –û–ø–ª–∞—á–µ–Ω–æ. –ü—Ä–æ–≤–µ—Ä—è—é –∞–∫—Ç–∏–≤–∞—Ü–∏—é...");
          await bootstrap();
        } else if (status === "cancelled") {
          toast("–û—Ç–º–µ–Ω–µ–Ω–æ");
        } else {
          toast("–û—à–∏–±–∫–∞ –æ–ø–ª–∞—Ç—ã: " + status);
        }
      });
    } catch (e) { toast(String(e.message || e)); }
  };

  // ====== –í–≤–æ–¥ –∫–∞—Ä—Ç ======
  const RANKS = ["A","K","Q","J","10","9","8","7","6","5","4","3","2"];
  const ranksBox = document.getElementById('ranks');
  let selectedRank = null;
  let cards = [];

  function stageLabel(){
    if (cards.length < 2) return `–∫–∞—Ä—Ç—ã –∏–≥—Ä–æ–∫–∞ (${cards.length}/2)`;
    return `—Ñ–ª–æ–ø (${cards.length-2}/3)`;
  }

  function render(){
    document.getElementById('stageText').textContent = stageLabel();
    setCardsText(cards.length ? cards.join("  ") : "‚Äî");
    document.querySelectorAll('.rank').forEach(b=>{
      b.classList.toggle('selected', b.dataset.rank === selectedRank);
    });
  }

  for (const r of RANKS){
    const b = document.createElement('button');
    b.textContent = r;
    b.className = 'rank';
    b.dataset.rank = r;
    b.onclick = ()=>{ selectedRank = r; render(); };
    ranksBox.appendChild(b);
  }

  document.querySelectorAll('button[data-suit]').forEach(b=>{
    b.onclick = async ()=>{
      const suit = b.dataset.suit;
      if (!selectedRank) { toast("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –Ω–æ–º–∏–Ω–∞–ª."); return; }
      if (cards.length >= 5) { toast("–£–∂–µ 5 –∫–∞—Ä—Ç."); selectedRank = null; render(); return; }

      const card = `${selectedRank}${suit}`;
      if (cards.includes(card)) { toast("–¢–∞–∫–∞—è –∫–∞—Ä—Ç–∞ —É–∂–µ –≤—ã–±—Ä–∞–Ω–∞."); selectedRank = null; render(); return; }

      cards.push(card);
      selectedRank = null;
      render();

      if (cards.length === 5){
        setResultText("–°—á–∏—Ç–∞—é‚Ä¶");
        try {
          const r = await apiPost("/api/ev", { cards });
          toast(r.verdict);
          setResultText(`${r.verdict}  |  EV(call)‚âà${Number(r.ev_call).toFixed(3)}  |  EV(fold)=${Number(r.ev_fold).toFixed(3)}`);
        } catch (e) {
          const msg = String(e.message || e);
          setResultText("‚Äî");
          if (msg.includes("subscription_required") || msg.includes("402")) {
            toast("‚ùå –ù—É–∂–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∞. –ù–∞–∂–º–∏—Ç–µ ¬´‚≠ê –û–ø–ª–∞—Ç–∏—Ç—å –ø–æ–¥–ø–∏—Å–∫—É¬ª.");
          } else if (msg.includes("device_mismatch") || msg.includes("403")) {
            toast("‚õî –î–æ—Å—Ç—É–ø –ø—Ä–∏–≤—è–∑–∞–Ω –∫ –¥—Ä—É–≥–æ–º—É —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É. –ù–∞–∂–º–∏—Ç–µ ¬´–ü–µ—Ä–µ–Ω–µ—Å—Ç–∏ –¥–æ—Å—Ç—É–ø¬ª.");
          } else {
            toast(msg);
          }
        }
      }
    };
  });

  document.getElementById('btnDel').onclick = ()=>{
    if (!cards.length) return;
    cards.pop();
    selectedRank = null;
    setResultText("‚Äî");
    render();
  };

  document.getElementById('btnReset').onclick = ()=>{
    cards = [];
    selectedRank = null;
    setResultText("‚Äî");
    render();
  };

  render();
  bootstrap();
</script>
</body>
</html>
